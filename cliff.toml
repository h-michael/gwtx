# git-cliff configuration file
# https://git-cliff.org/docs/configuration

# GitHub repository information (used for generating URLs in templates)
[remote.github]
owner = "h-michael"
repo = "gwtx"

[changelog]
# Changelog header section
header = """
# Changelog\n
"""

# Changelog body template (using Tera template engine)
# See https://keats.github.io/tera/docs/#introduction
body = """
{%- macro remote_url() -%}
  https://github.com/{{ remote.github.owner }}/{{ remote.github.repo }}
{%- endmacro -%}

{% if version %}\
    {% if previous.version %}\
        ## [{{ version | trim_start_matches(pat="v") }}]({{ self::remote_url() }}/compare/{{ previous.version }}..{{ version }}) - {{ timestamp | date(format="%Y-%m-%d") }}
    {% else %}\
        ## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
    {% endif %}\
{% else %}\
    ## [Unreleased]
{% endif %}
{% for commit in commits %}
    - **{{ commit.group }}**{% if commit.scope %}({{ commit.scope }}){% endif %}: \
        {% if commit.breaking %}[**breaking**] {% endif %}\
        {{ commit.message | upper_first }} - \
        ([{{ commit.id | truncate(length=7, end="") }}]({{ self::remote_url() }}/commit/{{ commit.id }}))\
{% endfor %}
{%- if github.contributors | filter(attribute="is_first_time", value=true) | length != 0 %}

## New Contributors
{% for contributor in github.contributors | filter(attribute="is_first_time", value=true) %}
* @{{ contributor.username }} made their first contribution\
    {%- if contributor.pr_number %} in \
      [#{{ contributor.pr_number }}]({{ self::remote_url() }}/pull/{{ contributor.pr_number }}) \
    {%- endif %}
{% endfor -%}
{%- endif %}\n
"""

# Changelog footer section
footer = """
<!-- generated by git-cliff -->
"""

# Remove leading and trailing whitespace
trim = true

[git]
# Parse commits according to the Conventional Commits specification
# See https://www.conventionalcommits.org
conventional_commits = true

# Exclude commits that don't follow Conventional Commits format
filter_unconventional = true

# Don't split multi-line commit messages into individual commits
split_commits = false

# Commit message preprocessors (regex-based)
# Convert issue/PR numbers to links
commit_preprocessors = [
    # Convert (#123) or (fix #123) to PR links
    { pattern = '\((\w+\s)?#([0-9]+)\)', replace = "([#${2}](https://github.com/h-michael/gwtx/pull/${2}))" },
]

# Commit message parsing rules
# Matched commits are included/excluded from the changelog
commit_parsers = [
    # Skip release commits and CHANGELOG updates (must come before general chore)
    { message = "^chore\\(release\\)", skip = true },
    { message = "^chore.*CHANGELOG", skip = true },

    # Skip Dependabot commits (dependency updates)
    { message = "^chore\\(deps\\)", skip = true },  # Cargo dependencies
    { message = "^chore\\(ci\\)", skip = true },    # GitHub Actions

    # Include all commit types
    { message = "^feat", group = "feat" },          # New features
    { message = "^fix", group = "fix" },            # Bug fixes
    { message = "^doc", group = "docs" },           # Documentation changes
    { message = "^perf", group = "perf" },          # Performance improvements
    { message = "^refactor", group = "refactor" },  # Refactoring
    { message = "^chore", group = "chore" },        # Chores (maintenance tasks)
]

# Always include breaking changes in changelog (even if skipped by commit_parsers)
protect_breaking_commits = true

# Exclude commits that don't match any commit_parser
# This ensures only feat/fix/docs/perf/refactor are included
filter_commits = true

# Git tag pattern for releases (regex)
tag_pattern = "v[0-9].*"

# Skip tags matching this pattern (e.g., beta, alpha)
# Changes from skipped tags will be included in the next release
skip_tags = ""

# Ignore tags matching this pattern
ignore_tags = ""

# Don't use topological order (use chronological order)
topo_order = false

# Sort order for commits within each release
# oldest: chronological order (merge order), newest: reverse chronological
sort_commits = "oldest"
